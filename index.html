<!DOCTYPE html>
<html lang="it" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50° Compleanno MAX - Double Trouble Event</title>

    <!-- SEO & Social Sharing -->
    <meta name="description"
        content="Partecipa al 50° Compleanno di Max! Gratta le card per scoprire i due eventi speciali.">

    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://GitMax76.github.io/50eSquat/">
    <meta property="og:title" content="50° Compleanno MAX - Double Trouble Event">
    <meta property="og:description"
        content="Due eventi, due scratch card! Gratta per scoprire e conferma la tua presenza!">
    <meta property="og:image" content="https://GitMax76.github.io/50eSquat/BDpreview.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://GitMax76.github.io/50eSquat/">
    <meta property="twitter:title" content="50° Compleanno MAX">
    <meta property="twitter:description"
        content="Due eventi, due scratch card! Gratta per scoprire e conferma la tua presenza!">
    <meta property="twitter:image" content="https://GitMax76.github.io/50eSquat/BDpreview.png">

    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile 90s Fitness */
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');

        body {
            font-family: 'Teko', sans-serif;
            background-color: #0c0a09;
            /* stone-950 */
            color: #f0f0f0;
            background-image:
                linear-gradient(rgba(13, 165, 234, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(13, 165, 234, 0.3) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .card {
            background-color: #1c1917;
            /* stone-900 */
            border: 4px solid #a5f3fc;
            /* cyan-200 */
            box-shadow: 0 0 20px #a5f3fc, 0 0 30px #a5f3fc inset;
            border-radius: 1rem;
        }

        .btn-neon {
            font-weight: 700;
            letter-spacing: 2px;
            background-color: #ec4899;
            /* pink-500 */
            color: #ffffff;
            border: 2px solid #f9a8d4;
            /* pink-200 */
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px #ec4899, 0 0 15px #ec4899;
        }

        .btn-neon:hover {
            background-color: #f9a8d4;
            color: #be185d;
            box-shadow: 0 0 20px #f9a8d4, 0 0 30px #f9a8d4;
            transform: scale(1.05);
        }

        .btn-neon:disabled {
            background-color: #52525b;
            /* zinc-600 */
            color: #a1a1aa;
            /* zinc-400 */
            border-color: #71717a;
            /* zinc-500 */
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        input[type="text"] {
            background-color: #262626;
            /* neutral-800 */
            border: 2px solid #a5f3fc;
            /* cyan-200 */
            color: #f0f0f0;
            border-radius: 0.5rem;
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 10px #a5f3fc;
        }

        /* Checkbox Custom Style */
        .checkbox-wrapper input:checked+div {
            background-color: #ec4899;
            border-color: #f9a8d4;
            box-shadow: 0 0 10px #ec4899;
        }

        h1 {
            font-size: clamp(5rem, 15vw, 12rem);
            /* Molto più grande e responsive */
            line-height: 0.9;
            font-weight: 700;
            text-shadow: 0 0 10px #ec4899, 0 0 30px #ec4899;
        }

        .scratch-card-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            cursor: crosshair;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #a5f3fc;
            background-color: #000;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        .image-underneath {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* Overlay text "Scratch Me" */
        .scratch-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
            /* Lascia passare i click al canvas */
            font-family: 'Permanent Marker', cursive;
            font-size: 3rem;
            /* Leggermente più grande */
            color: #ffffff;
            text-shadow: 0 0 10px #000, 0 0 20px #ec4899;
            text-align: center;
            width: 100%;
            animation: pulse-rotate 2s infinite ease-in-out;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .scratched .scratch-overlay-text {
            opacity: 0;
        }

        @keyframes pulse-rotate {
            0% {
                transform: translate(-50%, -50%) scale(1) rotate(-5deg);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
            }

            100% {
                transform: translate(-50%, -50%) scale(1) rotate(-5deg);
            }
        }
    </style>
</head>

<body class="min-h-full flex flex-col items-center justify-center p-4 overflow-x-hidden">

    <header class="text-center mb-12 mt-8">
        <h1 class="text-pink-400 mb-2 tracking-tighter font-bold"
            style="font-size: clamp(3rem, 8vw, 6rem) !important; line-height: 1;">50° Compleanno MAX</h1>
        <p class="text-cyan-400 text-3xl font-bold uppercase tracking-widest text-shadow-glow">Double Trouble Event</p>
    </header>

    <main class="w-full max-w-5xl">

        <!-- GRID LAYOUT -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">

            <!-- CARD 1 -->
            <div class="card p-4 flex flex-col items-center">
                <h2 class="text-4xl text-yellow-300 mb-2 font-bold uppercase">Primo Atto</h2>

                <div id="container-1" class="scratch-card-container mb-2">
                    <div class="scratch-overlay-text">
                        GRATTAMI!<br><span class="text-xl">Scratch Me</span>
                    </div>
                    <canvas id="canvas-1"></canvas>
                    <img id="img-1" src="" alt="Evento 1" class="image-underneath hidden" />
                </div>

                <!-- Progress Bar 1 -->
                <div class="w-full max-w-[300px] mb-4">
                    <div class="flex justify-between text-cyan-400 text-sm mb-1 font-bold">
                        <span>PROGRESSO</span>
                        <span id="text-1">0%</span>
                    </div>
                    <div
                        class="relative w-full bg-gray-800 h-6 rounded-full border border-gray-600 overflow-hidden box-content shadow-inner">
                        <!-- Goal Marker -->
                        <div class="absolute top-0 bottom-0 w-0.5 bg-yellow-400 z-10"
                            style="left: 60%; box-shadow: 0 0 5px yellow;"></div>
                        <div class="absolute top-0 bottom-0 text-xs text-yellow-400 font-bold z-10 flex items-center"
                            style="left: 62%; text-shadow: 1px 1px 1px black;">GOAL</div>

                        <div id="bar-1"
                            class="bg-pink-500 h-full w-0 transition-all duration-200 shadow-[0_0_10px_rgba(236,72,153,0.7)]">
                        </div>
                    </div>
                </div>

                <h3 class="text-2xl text-pink-400 font-bold mb-1">Special Fitness Class</h3>
                <p class="text-xl text-center text-gray-400 mb-2">Gratta per scoprire i dettagli!</p>
                <div id="status-event1" class="text-cyan-400 font-bold text-lg">Disponibilità: ...</div>
            </div>

            <!-- CARD 2 -->
            <div class="card p-4 flex flex-col items-center">
                <h2 class="text-4xl text-yellow-300 mb-2 font-bold uppercase">Secondo Atto</h2>

                <div id="container-2" class="scratch-card-container mb-2">
                    <div class="scratch-overlay-text">
                        GRATTAMI!<br><span class="text-xl">Scratch Me</span>
                    </div>
                    <canvas id="canvas-2"></canvas>
                    <img id="img-2" src="" alt="Evento 2" class="image-underneath hidden" />
                </div>

                <!-- Progress Bar 2 -->
                <div class="w-full max-w-[300px] mb-4">
                    <div class="flex justify-between text-cyan-400 text-sm mb-1 font-bold">
                        <span>PROGRESSO</span>
                        <span id="text-2">0%</span>
                    </div>
                    <div
                        class="relative w-full bg-gray-800 h-6 rounded-full border border-gray-600 overflow-hidden box-content shadow-inner">
                        <!-- Goal Marker -->
                        <div class="absolute top-0 bottom-0 w-0.5 bg-yellow-400 z-10"
                            style="left: 60%; box-shadow: 0 0 5px yellow;"></div>
                        <div class="absolute top-0 bottom-0 text-xs text-yellow-400 font-bold z-10 flex items-center"
                            style="left: 62%; text-shadow: 1px 1px 1px black;">GOAL</div>

                        <div id="bar-2"
                            class="bg-pink-500 h-full w-0 transition-all duration-200 shadow-[0_0_10px_rgba(236,72,153,0.7)]">
                        </div>
                    </div>
                </div>

                <h3 class="text-2xl text-pink-400 font-bold mb-1">Serata Giochi</h3>
                <p class="text-xl text-center text-gray-400 mb-2">Gratta per scoprire i dettagli!</p>
                <div id="status-event2" class="text-cyan-400 font-bold text-lg">Disponibilità: ...</div>
            </div>

        </div>

        <!-- RSVP SECTION -->
        <div class="card p-8 max-w-2xl mx-auto text-center">
            <h3 class="text-4xl text-pink-500 mb-6 uppercase">Prenotazione</h3>

            <div id="rsvp-form" class="hidden">
                <p class="text-xl mb-6 text-gray-200">Seleziona a cosa parteciperai:</p>

                <div class="flex flex-col md:flex-row justify-center gap-4 mb-8">
                    <!-- Checkbox Event 1 -->
                    <label class="checkbox-wrapper cursor-pointer select-none">
                        <input type="checkbox" id="check-event1" class="hidden" />
                        <div class="border-2 border-cyan-400 rounded-lg p-4 w-40 text-center transition-all">
                            <span class="block text-2xl font-bold text-white">Primo Atto</span>
                            <span class="text-sm text-gray-400">(Max 30)</span>
                        </div>
                    </label>

                    <!-- Checkbox Event 2 -->
                    <label class="checkbox-wrapper cursor-pointer select-none">
                        <input type="checkbox" id="check-event2" class="hidden" />
                        <div class="border-2 border-cyan-400 rounded-lg p-4 w-40 text-center transition-all">
                            <span class="block text-2xl font-bold text-white">Secondo Atto</span>
                            <span class="text-sm text-gray-400">(Max 40)</span>
                        </div>
                    </label>
                </div>

                <input type="text" id="name" placeholder="IL TUO NOME E COGNOME"
                    class="w-full max-w-sm p-3 text-2xl text-center mx-auto block mb-6 text-black uppercase font-bold" />

                <p id="form-error" class="text-red-500 hidden mb-4 font-bold text-xl uppercase"></p>

                <button id="submit-btn" class="btn-neon text-2xl px-8 py-3 w-full max-w-sm">
                    CONFERMO LA PRESENZA!
                </button>
            </div>

            <!-- Loading / Status -->
            <p id="global-status" class="text-2xl text-cyan-400 animate-pulse">Caricamento disponibilità...</p>
            <p id="debug-status"
                class="text-lg text-yellow-300 mt-4 hidden font-bold border border-yellow-300 p-2 rounded"></p>

            <!-- Success -->
            <div id="success-msg" class="hidden">
                <p class="text-3xl text-green-400 mb-2">Fantastico!</p>
                <p class="text-xl text-gray-200 mb-6">La tua prenotazione è stata registrata.</p>
                <a href="https://calendar.app.google/8vUrVBoVDBMzLfbz6" target="_blank"
                    class="text-cyan-400 underline text-lg">
                    Aggiungi al calendario
                </a>
            </div>
        </div>

    </main>

    <!-- Music Controls -->
    <div class="fixed bottom-4 right-4 z-50">
        <button id="music-btn"
            class="bg-gray-800 text-white p-3 rounded-full shadow-lg border-2 border-pink-500 hover:scale-110 transition-transform hidden">
            <svg id="music-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25a2.25 2.25 0 00-2.121-2.248l-12.068.75a2.25 2.25 0 00-2.062 2.248v9.112A2.25 2.25 0 004.87 14.2l1.636.468a1.803 1.803 0 11-.99 3.467l-2.31.66A2.25 2.25 0 011.605 16.6V7.935" />
            </svg>
        </button>
    </div>

    <!-- Hidden SoundCloud Widget -->
    <iframe id="sc-widget" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay"
        src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/plasma3/outrun-remix-splash-wave-remix&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true"
        style="display:none;">
    </iframe>

    <!-- SoundCloud Widget API -->
    <script src="https://w.soundcloud.com/player/api.js"></script>

    <script>
        // --- CONFIGURAZIONE ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwWcsRqoFDGqHhWLxQiUXYTM9whyCh8Hi5DBneieuZ9h5FNNMuYVsxihIMvC3Rs3twspA/exec";

        // --- CLASSE SCRATCH CARD ---
        class ScratchCard {
            constructor(containerId, canvasId, imgId, imgSrc, onProgress) {
                this.container = document.getElementById(containerId);
                this.canvas = document.getElementById(canvasId);
                this.image = document.getElementById(imgId);
                this.imgSrc = imgSrc;
                this.ctx = this.canvas.getContext("2d", { willReadFrequently: true });
                this.isDrawing = false;
                this.isReady = false;
                this.hasStarted = false;
                this.onProgress = onProgress || (() => { });
                this.percent = 0;
                this.lastCalc = 0; // Per throttling

                this.init();
            }

            init() {
                this.image.onload = () => {
                    this.setupCanvas();
                    this.image.classList.remove("hidden");
                    this.isReady = true;
                };

                this.image.onerror = () => {
                    console.error("Immagine non trovata:", this.imgSrc);
                };

                this.image.src = this.imgSrc;
            }

            setupCanvas() {
                const w = this.container.clientWidth;
                const h = this.container.clientHeight;

                this.canvas.width = w;
                this.canvas.height = h;

                this.ctx.fillStyle = "#ec4899"; // Pink neon
                this.ctx.fillRect(0, 0, w, h);

                this.ctx.globalCompositeOperation = "destination-out";
                this.ctx.lineWidth = 40;
                this.ctx.lineCap = "round";

                this.addListeners();
            }

            addListeners() {
                const start = (e, isTouch) => this.start(e, isTouch);
                const move = (e, isTouch) => this.draw(e, isTouch);
                const end = () => this.stop();

                this.canvas.addEventListener("mousedown", (e) => start(e, false));
                this.canvas.addEventListener("mousemove", (e) => move(e, false));

                // Miglioramento UX: stop solo se rilascio il mouse ovunque nella finestra
                window.addEventListener("mouseup", end);
                // Rimosso mouseleave per permettere di uscire e rientrare col mouse premuto

                this.canvas.addEventListener("touchstart", (e) => start(e, true), { passive: false });
                this.canvas.addEventListener("touchmove", (e) => move(e, true), { passive: false });
                this.canvas.addEventListener("touchend", end, { passive: false });
            }

            getPos(e, isTouch) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) * (this.canvas.width / rect.width),
                    y: (clientY - rect.top) * (this.canvas.height / rect.height)
                };
            }

            start(e, isTouch) {
                if (isTouch) e.preventDefault();
                // Mouse sinistro solo
                if (!isTouch && e.button !== 0) return;

                this.isDrawing = true;

                if (!this.hasStarted) {
                    this.container.classList.add("scratched");
                    this.hasStarted = true;
                }

                const pos = this.getPos(e, isTouch);
                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
            }

            stop() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.ctx.closePath();
                    this.calcProgress();
                }
            }

            draw(e, isTouch) {
                if (!this.isDrawing) return;
                if (isTouch) e.preventDefault();
                const pos = this.getPos(e, isTouch);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();

                // Throttled progress check (ogni 200ms)
                if (Date.now() - this.lastCalc > 200) {
                    this.calcProgress();
                    this.lastCalc = Date.now();
                }
            }

            calcProgress() {
                try {
                    const w = this.canvas.width;
                    const h = this.canvas.height;

                    // Ottimizzazione: campioniamo ogni 4 pixel per velocità
                    const imageData = this.ctx.getImageData(0, 0, w, h);
                    const data = imageData.data;
                    const step = 4 * 10; // Controlliamo 1 pixel ogni 10
                    let transparentPixels = 0;
                    let totalPixels = 0;

                    for (let i = 0; i < data.length; i += step) {
                        const alpha = data[i + 3]; // Canale Alpha
                        if (alpha < 128) {
                            transparentPixels++;
                        }
                        totalPixels++;
                    }

                    this.percent = Math.round((transparentPixels / totalPixels) * 100);
                    this.onProgress(this.percent);
                } catch (e) {
                    console.error("Errore calcolo progresso:", e);
                    // Se siamo in locale, è probabile che sia un errore di sicurezza (CORS/Tainted Canvas)
                    if (e.name === "SecurityError") {
                        const debugEl = document.getElementById("debug-status");
                        if (debugEl) {
                            debugEl.innerHTML = "⚠️ <b>ERRORE SICUREZZA BROWSER:</b><br>Impossibile leggere il progresso se apri il file direttamente.<br>Usa un Local Server (es. VS Code 'Live Server').";
                            debugEl.classList.remove("hidden");
                        }
                    }
                }
            }
        }

        // --- APP LOGIC ---
        const ui = {
            check1: document.getElementById("check-event1"),
            check2: document.getElementById("check-event2"),
            name: document.getElementById("name"),
            btn: document.getElementById("submit-btn"),
            error: document.getElementById("form-error"),
            form: document.getElementById("rsvp-form"),
            globalStatus: document.getElementById("global-status"),
            debugStatus: document.getElementById("debug-status"),
            success: document.getElementById("success-msg"),
            statusEv1: document.getElementById("status-event1"),
            statusEv2: document.getElementById("status-event2"),
            bar1: document.getElementById("bar-1"),
            text1: document.getElementById("text-1"),
            bar2: document.getElementById("bar-2"),
            text2: document.getElementById("text-2"),
            musicBtn: document.getElementById("music-btn"),
            musicIcon: document.getElementById("music-icon")
        };

        const state = {
            serverReady: false,
            availability: null,
            scratch1: 0,
            scratch2: 0,
            isPlaying: false
        };

        function updateFormVisibility() {
            // Mostra form solo se:
            // 1. Server ha risposto OK e ci sono posti
            // 2. Entrambe le card sono grattate > 60% (era 70%)

            const isScratched = state.scratch1 > 60 && state.scratch2 > 60;
            const hasSpots = state.availability &&
                (state.availability.event1 !== "full" || state.availability.event2 !== "full");

            if (state.serverReady && hasSpots) {
                if (isScratched) {
                    ui.form.classList.remove("hidden");
                    ui.globalStatus.classList.add("hidden");
                } else {
                    ui.form.classList.add("hidden");
                    ui.globalStatus.textContent = "GRATTA ENTRAMBI I RIQUADRI PER PRENOTARTI!";
                    ui.globalStatus.classList.replace("text-red-500", "text-cyan-400");
                    ui.globalStatus.classList.remove("animate-pulse"); // Stop pulse to make it readable
                    ui.globalStatus.classList.remove("hidden");
                }
            } else if (state.serverReady && !hasSpots) {
                ui.globalStatus.textContent = "TUTTO ESAURITO!";
                ui.globalStatus.classList.replace("text-cyan-400", "text-red-500");
                ui.globalStatus.classList.remove("hidden");
            }
        }

        async function checkAvailability() {
            ui.globalStatus.textContent = "Caricamento disponibilità...";
            ui.globalStatus.classList.remove("text-red-500");
            ui.globalStatus.classList.add("text-cyan-400", "animate-pulse");

            try {
                // Fetch con no-cors potrebbe essere problematica per leggere il body, 
                // ma Google Apps Script Web App (se pubblica) supporta CORS.
                const res = await fetch(`${WEB_APP_URL}?action=check&_t=${Date.now()}`);

                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);

                const data = await res.json();
                console.log("Check:", data);

                if (data.status === "success") {

                    // --- FIX PER BACKEND NON AGGIORNATO ---
                    if (!data.counts) {
                        throw new Error(`VERSIONE OBSOLETA DELLO SCRIPTT.<br>Dati Ricevuti: <pre class="text-xs text-left overflow-auto max-h-40 bg-gray-800 p-2 mt-2">${JSON.stringify(data, null, 2)}</pre>`);
                    }

                    const {
                        counts,
                        limits,
                        availability
                    } = data;

                    // Aggiorna UI Evento 1
                    ui.statusEv1.textContent = `${counts.event1} / ${limits.event1} Partecipanti`;
                    if (availability.event1 === "full") {
                        ui.statusEv1.classList.replace("text-cyan-400", "text-red-500");
                        ui.statusEv1.textContent += " (SOLD OUT)";
                        ui.check1.disabled = true;
                        ui.check1.parentElement.classList.add("opacity-50", "pointer-events-none");
                    }

                    // Aggiorna UI Evento 2
                    ui.statusEv2.textContent = `${counts.event2} / ${limits.event2} Partecipanti`;
                    if (availability.event2 === "full") {
                        ui.statusEv2.classList.replace("text-cyan-400", "text-red-500");
                        ui.statusEv2.textContent += " (SOLD OUT)";
                        ui.check2.disabled = true;
                        ui.check2.parentElement.classList.add("opacity-50", "pointer-events-none");
                    }

                    state.availability = availability;
                    state.serverReady = true;
                    updateFormVisibility();

                } else {
                    throw new Error(data.message || "Risposta API non valida");
                }
            } catch (e) {
                console.error(e);
                ui.globalStatus.textContent = "Errore connessione al Server.";
                ui.globalStatus.classList.replace("text-cyan-400", "text-red-500");
                ui.globalStatus.classList.remove("animate-pulse");

                // Debug info
                ui.debugStatus.innerHTML = `⚠️ <b>ATTENZIONE:</b> ${e.message}`;
                ui.debugStatus.classList.remove("hidden");
            }
        }

        // --- MUSIC PLAYER LOGIC ---
        let scWidget;

        function initAudio() {
            const iframe = document.getElementById('sc-widget');
            scWidget = SC.Widget(iframe);

            ui.musicBtn.classList.remove("hidden");

            // Tenta autoplay alla prima interazione
            const startAudio = () => {
                if (!state.isPlaying) {
                    scWidget.play();
                }
                document.removeEventListener('click', startAudio);
                document.removeEventListener('touchstart', startAudio);
            };

            document.addEventListener('click', startAudio);
            document.addEventListener('touchstart', startAudio);

            scWidget.bind(SC.Widget.Events.PLAY, () => {
                state.isPlaying = true;
                updateMusicBtn();
            });

            scWidget.bind(SC.Widget.Events.PAUSE, () => {
                state.isPlaying = false;
                updateMusicBtn();
            });

            ui.musicBtn.addEventListener("click", (e) => {
                e.stopPropagation(); // Evita di triggerare startAudio
                scWidget.toggle();
            });
        }

        function updateMusicBtn() {
            if (state.isPlaying) {
                ui.musicBtn.classList.replace("bg-gray-800", "bg-pink-500");
                ui.musicBtn.classList.add("animate-pulse");
                ui.musicIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                `; // Pause Icon
            } else {
                ui.musicBtn.classList.replace("bg-pink-500", "bg-gray-800");
                ui.musicBtn.classList.remove("animate-pulse");
                ui.musicIcon.innerHTML = `
                   <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                `; // Play Icon
            }
        }

        async function submitRSVP() {
            ui.error.classList.add("hidden");

            const name = ui.name.value.trim();
            const ev1 = ui.check1.checked;
            const ev2 = ui.check2.checked;

            if (!name) {
                ui.error.textContent = "INSERISCI IL TUO NOME!";
                ui.error.classList.remove("hidden");
                return;
            }
            if (!ev1 && !ev2) {
                ui.error.textContent = "SELEZIONA ALMENO UN EVENTO!";
                ui.error.classList.remove("hidden");
                return;
            }

            const events = [];
            if (ev1) events.push("event1");
            if (ev2) events.push("event2");

            ui.btn.disabled = true;
            ui.btn.textContent = "INVIO...";

            try {
                // Send as JSON to match backend parsing logic
                const payload = {
                    name: name,
                    events: events.join(","),
                    _t: Date.now()
                };

                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain to avoid CORS preflight issues in GAS
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.status === "success") {
                    ui.form.classList.add("hidden");
                    ui.success.classList.remove("hidden");
                    // Nascondi anche eventuali messaggi di stato
                    ui.globalStatus.classList.add("hidden");
                } else {
                    throw new Error(data.message);
                }

            } catch (e) {
                ui.error.textContent = "ERRORE: " + e.message;
                ui.error.classList.remove("hidden");
                ui.btn.disabled = false;
                ui.btn.textContent = "RIPROVA";
            }
        }

        // --- INIT ---
        function init() {
            const path = window.location.pathname;
            const baseUrl = path.endsWith('/') ? path.slice(0, -1) : path.substring(0, path.lastIndexOf('/'));
            const origin = window.location.origin;

            const updateBar = (bar, text, p) => {
                bar.style.width = `${p}%`;
                text.textContent = `${p}%`;

                if (p >= 60) {
                    bar.classList.replace("bg-pink-500", "bg-green-500");
                    bar.classList.add("shadow-[0_0_15px_rgba(34,197,94,0.9)]");
                    text.classList.replace("text-cyan-400", "text-green-400");
                } else {
                    bar.classList.replace("bg-green-500", "bg-pink-500");
                    bar.classList.remove("shadow-[0_0_15px_rgba(34,197,94,0.9)]");
                    text.classList.replace("text-green-400", "text-cyan-400");
                }
            };

            // Cards con callback di progresso
            const card1 = new ScratchCard("container-1", "canvas-1", "img-1", `${origin}${baseUrl}/50eSquat.png`, (p) => {
                state.scratch1 = p;
                updateBar(ui.bar1, ui.text1, p);
                updateFormVisibility();
            });

            const card2 = new ScratchCard("container-2", "canvas-2", "img-2", `${origin}${baseUrl}/level50.png`, (p) => {
                state.scratch2 = p;
                updateBar(ui.bar2, ui.text2, p);
                updateFormVisibility();
            });

            // Listeners
            ui.btn.addEventListener("click", submitRSVP);

            // Fetch info iniziali
            checkAvailability();

            // Init Audio
            initAudio();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>